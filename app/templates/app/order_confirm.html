{% extends "app/base.html" %}
{% load humanize %}

{% block content %}
<div class="order-title">
    <span>ORDER</span>
</div>

<p class="text-center">以下の内容でよろしいでしょうか？</p>
<p id="error" class="d-none"></p>
<div class="row">
    <div class="col-7">
        <table class="profile__table">
            <tbody>
                <tr>
                    <th>お名前</th>
                    <td id="name">{{ name }}</td>
                </tr>
                <tr>
                    <th>フリガナ</th>
                    <td id="furigana">{{ furigana }}</td>
                </tr>
                <tr>
                    <th>メールアドレス</th>
                    <td id="email">{{ email }}</td>
                </tr>
                <tr>
                    <th>電話番号</th>
                    <td id="tel">{{ tel }}</td>
                </tr>
                <tr>
                    <th>受取日時</th>
                    <td id="receipt">{{ date }}　{{ time }}</td>
                </tr>
            </tbody>
        </table>
        <div class="text-left">
            <span>※お支払いは店頭にて現金のみとなります。</span><br>
            <span>※店舗の状況により商品のお渡しにお時間をいただく場合がございます。</span>
        </div>
    </div>
    <div class="col-3">
        <div class="card">
            <p class="text-center">ご注文内容</p>
            {% for cart in cart_data %}
                <div class="d-flex justify-content-between">
                    <span>{{ cart.size_title }}</span>
                    <span>￥{{ cart.size_price }}</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>{{ cart.flavor_title }}</span>
                    <span>￥{{ cart.flavor_price }}</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>{{ cart.flavor2_title }}</span>
                    {% if cart.flavor2_title != "" %}
                    <span>￥{{ cart.flavor2_price }}</span>
                    {% endif %}
                </div>
                <div class="d-flex justify-content-between">
                    <span>{{ cart.option_title }}</span>
                    {% if cart.option_title != "" %}
                    <span>￥{{ cart.option_price }}</span>
                    {% endif %}
                </div>
                <div class="d-flex justify-content-between">
                    <span>{{ cart.option2_title }}</span>
                    {% if cart.option2_title != "" %}
                    <span>￥{{ cart.option2_price }}</span>
                    {% endif %}
                </div>
                <div class="d-flex justify-content-between">
                    <span>{{ cart.option3_title }}</span>
                    {% if cart.option3_title != "" %}
                        <span>￥{{ cart.option3_price }}</span>
                    {% endif %}
                </div>
                <hr>
            {% endfor %}
            <p class="text-center">合計：￥
                <span>{{ get_total_price|intcomma }}</span>
            </p>
        </div>
    </div>
</div>

<div class="mt-5 text-center">
    <button type="button" onclick="history.back()">戻る</button>
    <a id="order_done" class="btn rounded-pill" href="{% url 'order_thanks' %}" ontouchstart=''">注文を確定</a>
</div>
{% endblock %}

{% block extrajs %}
<script>
    'use strict';

    // CSRF対策
    const getCookie = name => {
        if (document.cookie && document.cookie !== '') {
            for (const cookie of document.cookie.split(';')) {
                const [key, value] = cookie.trim().split('=');
                if (key === name) {
                    return decodeURIComponent(value);
                }
            }
        }
    };
    const csrftoken = getCookie('csrftoken');

    // 注文を確定ボタンクリックで発動
    document.getElementById('order_done').addEventListener('click', e => {// ページ遷移をキャンセル
        let name = document.getElementById('name')
        let furigana = document.getElementById('furigana')
        let email = document.getElementById('email')
        let tel = document.getElementById('tel')
        let receipt = document.getElementById('receipt')
        if ( name.textContent == '' ||  furigana.textContent == '' || email.textContent == '' || tel.textContent == '' || receipt.textContent == '' ) {
            e.preventDefault(); // ページ遷移をキャンセル
            error.className = 'd-block text-center';
            error.style.color = 'red';
            error.textContent = '※ページを戻ってご注文者様の情報を入力してください';
        } else {
            const url = '{% url "order_thanks" %}';

            // 日付から【本日】or【翌日】を削除
            let date = '{{ date }}'.replace( /【本日】/g, '').replace( /【明日】/g, '');
            // 12月で1月の日付を選択したら翌年を追加
            if ( new Date().getMonth() + 1 == 12 && '{{ date }}'.slice(0, 1) == 1 ) {
                var year = new Date().getFullYear() + 1;
            } else {
                var year = new Date().getFullYear();
            }
            let receipt = year + '年' + date + ' ' + '{{ time }}'

            // URLのクエリパラメータを管理
            const body = new URLSearchParams();
            body.append('name', '{{ name }}');
            body.append('furigana', '{{ furigana }}');
            body.append('email', '{{ email }}');
            body.append('tel', '{{ tel }}');
            body.append('receipt', receipt);

            fetch(url, {
                method: 'POST',
                body: body,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8',
                    'X-CSRFToken': csrftoken,
                }
            })
        }
    });
</script>
{% endblock %}