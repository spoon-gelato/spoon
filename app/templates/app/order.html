{% extends "app/base.html" %}
{% load static %}
{% load widget_tweaks %}
{% load humanize %}

{% block title %}
<title>商品注文 | spoon</title>
{% endblock %}

{% block content %}
<div class="order-title">
    <span>ORDER</span>
</div>

<div class="mx-auto">
    <div class="row">
        <div class="col-9">
            <p class="text-center">STEP1.　ジェラートのサイズをお選びください。</p>
            <div class="row">
                {% for size in size_item %}
                <div class="col-3 selection-group">
                    <input id="size_{{ size.id }}" type="checkbox" name="size" value="{{ size.title }} {{ size.price }}">
                    <label for="size_{{ size.id }}">
                        <img src="{{ size.image.url }}">
                        <p class="m-0">{{ size.title }}</p>
                        <p class="m-0">￥{{ size.price }}</p>
                    </label>
                </div>
                {% endfor %}
            </div>
            <p class="text-center">STEP2.　ジェラートのフレーバーをお選びください。</p>
            <div class="row">
                {% for flavor in flavor_item %}
                <div class="col-3 selection-group">
                    <input id="flavor_{{ flavor.id }}" type="checkbox" name="flavor" value="{{ flavor.title }} {{ flavor.price }}" onclick="to_check()">
                    <label for="flavor_{{ flavor.id }}">
                        <img src="{{ flavor.image.url }}">
                        <p class="m-0">{{ flavor.title }}</p>
                        <p class="m-0">+￥{{ flavor.price }}</p>
                    </label>
                </div>
                {% endfor %}
            </div>
            <p class="text-center">STEP3.　オプションをお選びください。　※任意</p>
            <div class="row">
                {% for option in option_item %}
                <div class="col-3 selection-group">
                    <input id="option_{{ option.id }}" type="checkbox" name="option">
                    <label for="option_{{ option.id }}">
                        <img src="{{ option.image.url }}">
                        <p class="m-0">{{ option.title }}</p>
                        <p class="m-0">+￥{{ option.price }}</p>
                    </label>
                </div>
                {% endfor %}
            </div>
            <div class="my-5 text-center">
                <a id="order_plus" class="btn btn-primary">追加注文する</a>
                <a id="order_next" class="btn btn-danger" href="/">ご注文手続きへ</a>
            </div>
        </div>
        <div class="col-3">
            <div class="card">
                <p class="text-center">ご注文内容</p>
                <div class="d-flex justify-content-between">
                    <span id="size_title"></span>
                    <span id="size_price"></span>
                </div>
                <div class="d-flex justify-content-between">
                    <span id="flavor_title"></span>
                    <span id="flavor_price"></span>
                </div>
                <div class="d-flex justify-content-between">
                    <span id="flavor2_title"></span>
                    <span id="flavor2_price"></span>
                </div>
                <div class="d-flex justify-content-between">
                    <span id="option_title"></span>
                    <span id="option_price"></span>
                </div>
                <div class="d-flex justify-content-between">
                    <span id="option2_title"></span>
                    <span id="option2_price"></span>
                </div>
                <div class="d-flex justify-content-between">
                    <span id="option3_title"></span>
                    <span id="option3_price"></span>
                </div>
                <p class="text-center">合計：￥
                    <span id="total" class="d-none">0</span>
                    <span id="total_price">{{ get_total_price|intcomma }}</span>
                </p>
                <a id="order_next_2" class="btn btn-danger" href="/">ご注文手続きへ</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extrajs %}
<script>
    'use strict';

    // サイズ・フレーバー・オプションを取得
    let size = document.getElementsByName('size')
    let flavor = document.getElementsByName('flavor')
    let option = document.getElementsByName('option')
    // // カート内のフレーバーフィールドを取得
    const size_title = document.getElementById('size_title');
    const size_price = document.getElementById('size_price');
    const flavor_title = document.getElementById('flavor_title');
    const flavor_price = document.getElementById('flavor_price');
    const flavor2_title = document.getElementById('flavor2_title');
    const flavor2_price = document.getElementById('flavor2_price');
    const option_title = document.getElementById('option_title');
    const option_price = document.getElementById('option_price');
    const option2_title = document.getElementById('option2_title');
    const option2_price = document.getElementById('option2_price');
    const option3_title = document.getElementById('option3_title');
    const option3_price = document.getElementById('option3_price');
    const total = document.getElementById('total');
    const total_price = document.getElementById('total_price');

    // フレーバーとオプションの選択を無効化
    const invalid = (type) => {
        for ( let i = 0; i < type.length; i++ ) {
            type[i].disabled = true;
            flavor[i].checked = false;
        }
    }
    invalid(flavor);
    invalid(option);

    // サイズの選択を択一に設定
    const ckbox1 = () => {
        size[1].checked=false;
        size[2].checked=false;
        invalid(flavor);
        invalid(option);
        to_check()
    }
    const ckbox2 = () => {
        size[0].checked=false;
        size[2].checked=false;
        invalid(flavor);
        invalid(option);
        to_check()
    }
    const ckbox3 = () => {
        size[0].checked=false;
        size[1].checked=false;
        invalid(flavor);
        invalid(option);
        to_check()
    }
    size[0].onclick = ckbox1;
    size[1].onclick = ckbox2;
    size[2].onclick = ckbox3;

    // サイズ・フレーバー・オプションのいずれかを選択すると発動
    const to_check = () => {
        // サイズの選択に合わせてフレーバーの選択を制限
        const chk = (num) => {
            var flag = new Array();
            let count = 0;
            // フレーバーが選択される毎にflagへ値を追加してカウントを1上げる
            for ( let i = 0; i < flavor.length; i++ ) {
                if ( flavor[i].checked ) {
                    flag[i] = 'chk'; count++;
                }
            }
            // カウントがnumになったら発動
            // フレーバーの選択とflagの値を判定
            if ( count == num ) {
                for ( let j = 0; j < flavor.length; j++ ) {
                    if ( flag[j] == 'chk' ) {
                        flavor[j].disabled = false;
                    } else {
                        flavor[j].disabled = true;
                    }
                }
            }
        }

        // サイズ選択時の挙動
        size_title.textContent = '';
        size_price.textContent = '';
        for ( let k = 0; k < size.length; k++ ) {
            if ( size[k].checked ) {
                // サイズが選択されたらフレーバーの選択を有効化
                for ( let l = 0; l < flavor.length; l++ ) {
                    flavor[l].disabled = false;
                }
                // サイズフォームのバリュー値を取得
                let size_value = size[k].value.split(' ');
                size_title.textContent = size_value[0];
                size_price.textContent = '￥' + size_value[1];
                let size_total = size_value[1];
                if ( k < 2 ) {
                    chk(1);
                } else if ( k == 2 ) {
                    chk(2);
                }
            }
        }
    }
</script>
{% endblock %}