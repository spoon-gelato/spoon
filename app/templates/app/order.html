{% extends "app/base.html" %}
{% load static %}
{% load widget_tweaks %}
{% load humanize %}

{% block title %}
<title>商品注文 | spoon</title>
{% endblock %}

{% block content %}
<div class="order-title">
    <span>ORDER</span>
</div>

<div class="text-center mx-auto rounded">
    <div class="row">
        <div class="col-9">
            <p>STEP1.　ジェラートのサイズをお選びください。</p>
            <div class="selection-group">
                {% csrf_token %}
                <input id="mini_size" type="radio" name="size" value="ミニサイズ ￥280" onclick="total_fee()" onchange="initialization()">
                <label for="mini_size">
                    <img src="{% static 'img/size_ダミー.png' %}">
                    <p>ミニサイズ</p>
                    <p>￥280</p>
                </label>
                <input id="single_size" type="radio" name="size" value="シングルサイズ ￥330" onclick="total_fee()" onchange="initialization()">
                <label for="single_size">
                    <img src="{% static 'img/size_ダミー.png' %}">
                    <p>シングルサイズ</p>
                    <p>￥330</p>
                </label>
                <input id="double_size" type="radio" name="size" value="ダブルサイズ ￥440" onclick="total_fee()" onchange="initialization()">
                <label for="double_size">
                    <img src="{% static 'img/size_ダミー.png' %}">
                    <p>ダブルサイズ</p>
                    <p>￥440</p>
                </label>
            </div>
            <p class="order-text">STEP2.　ジェラートのフレーバーをお選びください。</p>
            <div class="selection-group">
                <input id="vanilla" type="checkbox" name="flavor" value="バニラ" onclick="total_fee()">
                <label for="vanilla">
                    <img src="{% static 'img/flavor_ダミー.png' %}">
                    <p>バニラ</p>
                </label>
                <input id="orange" type="checkbox" name="flavor" value="オレンジ" onclick="total_fee()">
                <label for="orange">
                    <img src="{% static 'img/flavor_ダミー.png' %}">
                    <p>オレンジ</p>
                </label>
                <input id="mango" type="checkbox" name="flavor" value="マンゴー" onclick="total_fee()">
                <label for="mango">
                    <img src="{% static 'img/flavor_ダミー.png' %}">
                    <p>マンゴー</p>
                </label>
            </div>
            <p class="order-text">STEP3.　オプションをお選びください。　※任意</p>
            <div class="selection-group">
                <input id="corn" type="checkbox" name="option" value="コーン ￥50" onclick="total_fee()">
                <label for="corn">
                    <img src="{% static 'img/コーン_ダミー.png' %}">
                    <p>コーン</p>
                    <p>￥50</p>
                </label>
                <input id="dryice" type="checkbox" name="option" value="ドライアイス ￥50" onclick="total_fee()">
                <label for="dryice">
                    <img src="{% static 'img/ドライアイス_ダミー.png' %}">
                    <p>ドライアイス</p>
                    <p>￥50</p>
                </label>
            </div>
            <!-- <p class="order-text">4.　ご注文様情報をご入力ください。</p>
            <div class="mb-3">
            {% render_field form.name class="form-control" placeholder="名前" %}
            </div>
            <div class="mb-3">
                {% render_field form.email class="form-control" placeholder="メールアドレス" %}
            </div>
            <div class="mb-3">
                {% render_field form.phone class="form-control" placeholder="電話番号" %}
            </div> -->
            <div class="mb-3">
                <form id="order_plus" method="POST">
                    {% csrf_token %}
                    <button class="btn btn-primary" type="submit">追加注文する</button>
                </form>
                <form method="POST">
                    {% csrf_token %}
                    <button class="btn btn-danger" type="submit">お支払いに進む</button>
                </form>
            </div>
        </div>
        <div class="col-3">
            <div class="card">
                <p>ご注文内容</p>
                <div id="posts">
                    {% for cart in cart_data %}
                        <div class="order_cart">
                            <div class="d-flex justify-content-between">
                                <span>{{ cart.size_title }}</span>
                                <div>
                                    <span class="mr-2">{{ cart.size_price }}</span>
                                    <span class="order_delete" onclick="del_order()">✕</span>
                                </div>
                            </div>
                            <div class="text-left">
                                <span>{{ cart.flavor_title }}</span>
                            </div>
                            <div class="text-left">
                                <span>{{ cart.flavor_title_2 }}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>{{ cart.option_title }}</span>
                                <span class="mr-4">{{ cart.option_price }}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>{{ cart.option_title_2 }}</span>
                                <span class="mr-4">{{ cart.option_price_2 }}</span>
                            </div>
                            <hr>
                        </div>
                    {% endfor %}
                </div>
                <div class="d-flex justify-content-between">
                    <span id="size_title"></span>
                    <span id="size_price"></span>
                </div>
                <div class="text-left">
                    <span id="flavor_title"></span>
                </div>
                <div class="text-left">
                    <span id="flavor_title_2"></span>
                </div>
                <div class="d-flex justify-content-between">
                    <span id="option_title"></span>
                    <span id="option_price"></span>
                </div>
                <div class="d-flex justify-content-between">
                    <span id="option_title_2"></span>
                    <span id="option_price_2"></span>
                </div>
                <p>合計：￥
                    <span id="total" class="d-none">0</span>
                    <span id="total_price">{{ get_total_price|intcomma }}</span>
                </p>
                <button class="btn btn-danger">お支払いに進む</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
<script>
    'use strict';

    //各サイズと各オプションの金額を設定
    const size = [280, 330, 440];
    const option = [50, 50];
    // サイズ・フレーバー・オプションを配列で取得
    const sizeform = document.getElementsByName('size')
    const flavorform = document.getElementsByName('flavor')
    const optionform = document.getElementsByName('option')
    // カート内のフレーバーフィールドを取得
    const flavor_title = document.getElementById('flavor_title');
    const flavor_title_2 = document.getElementById('flavor_title_2');

    // フレーバー選択とオプション選択を無効化しておく
    const format = (form) => {
        for ( let i = 0; i < form.length; i++ ) {
            form[i].disabled = true;
        }
    } 
    format(flavorform);
    format(optionform);

    // サイズ・フレーバー・オプションのいずれかを選択すると発動
    const total_fee = () => {
        // サイズ・オプションの取得金額にデフォルト値を設定
        let size_total = 0;
        let option_total = 0;
        // カート内のオプションフィールドを取得
        const option_title = document.getElementById('option_title');
        const option_price = document.getElementById('option_price');
        const option_title_2 = document.getElementById('option_title_2');
        const option_price_2 = document.getElementById('option_price_2');

        // サイズの選択に合わせたチェックの制限数を設定
        const chk = (num) => {
            let flag = new Array();
            let count = 0;
            // フレーバーが選択される毎にflagへ値を追加してカウントを1上げる
            for ( let i = 0; i < flavorform.length; i++ ) {
                if ( flavorform[i].checked ) {
                    flag[i] = 'chk'; count++;
                }
            }
            // カウントがnumになったら発動
            // フレーバーの選択とflagの値を判定
            if ( count >= num ) {
                for ( let j = 0; j < flavorform.length; j++ ) {
                    if ( flag[j] == 'chk' ) {
                        flavorform[j].disabled = false;
                    } else {
                        flavorform[j].disabled = true;
                    }
                }
            }
        }

        for ( let k = 0; k < size.length; k++ ) {
            if ( sizeform[k].checked ) {
                // サイズが選択されたらフレーバーの選択を有効化
                for ( let l = 0; l < flavorform.length; l++ ) {
                    flavorform[l].disabled = false;
                }
                let size_value = sizeform[k].value.split(' ');
                document.getElementById('size_title').textContent = size_value[0];
                document.getElementById('size_price').textContent = size_value[1];
                size_total = size[k];
                if ( k == 0 || k == 1 ) {
                    chk(1);
                } else if ( k == 2 ) {
                    chk(2);
                }
            }
        }

        flavor_title.textContent = '';
        flavor_title_2.textContent = '';
        for ( let m = 0; m < 3; m++ ) {
            if ( flavorform[m].checked ) {
                // フレーバーが選択されたらオプションの選択を有効化
                for ( let n = 0; n < optionform.length; n++ ) {
                    optionform[n].disabled = false;
                }
                let flavor_value = flavorform[m].value;
                if ( flavor_title.textContent == '' && flavor_title_2.textContent == '' ) {
                    flavor_title.textContent = flavor_value;
                } else if ( flavor_title_2.textContent == '' ) {
                    flavor_title_2.textContent = flavor_value;
                }
            }
        }

        option_title.textContent = '';
        option_price.textContent = '';
        option_title_2.textContent = '';
        option_price_2.textContent = '';
        for ( let o = 0; o < option.length; o++ ) {
            if ( optionform[o].checked ) {
                const option_value = optionform[o].value.split(' ');
                if ( o == 0 ) {
                    option_title.textContent = option_value[0];
                    option_price.textContent = option_value[1];
                } 
                if ( o == 1 ) {
                    option_title_2.textContent = option_value[0];
                    option_price_2.textContent = option_value[1];
                }
                option_total += option[o];
            }
        }
        // 非同期通信状態かリロードされたかを判定
        const total = document.getElementById('total');
        if ( total.textContent == 0 ) {
            // データベースから最新の合計値を取得して足す
            let total_price = Number('{{ get_total_price }}') + size_total + option_total;
            document.getElementById('total_price').textContent = total_price.toLocaleString();
        } else {
            // カンマを除いて整数値へ変換後、非同期通信で合計値を足す
            let total_flag = total.textContent.replace( /,/g, '');
            let total_price = Number(total_flag) + size_total + option_total;
            document.getElementById('total_price').textContent = total_price.toLocaleString();
        }
    }


    // サイズをクリックで発動。フレーバーの選択を初期化
    const initialization = () => {
        for ( let i = 0; i < flavorform.length; i++ ) {
            flavorform[i].checked = false;
            flavor_title.textContent = '';
            flavor_title_2.textContent = '';
        }
    }


    // CSRF対策
    const getCookie = name => {
        if (document.cookie && document.cookie !== '') {
            for (const cookie of document.cookie.split(';')) {
                const [key, value] = cookie.trim().split('=');
                if (key === name) {
                    return decodeURIComponent(value);
                }
            }
        }
    };
    const csrftoken = getCookie('csrftoken');

    // 追加注文をクリックで発動
    const addOrder = document.getElementById('order_plus');
    addOrder.addEventListener('submit', e => {
        e.preventDefault();
        const url = '{% url "add_order" %}';
        const size_title = document.getElementById('size_title');
        const size_price = document.getElementById('size_price');
        const flavor_title = document.getElementById('flavor_title');
        const flavor_title_2 = document.getElementById('flavor_title_2');
        const option_title = document.getElementById('option_title');
        const option_price = document.getElementById('option_price');
        const option_title_2 = document.getElementById('option_title_2');
        const option_price_2 = document.getElementById('option_price_2');
        const total_price = document.getElementById('total_price');
        const total = document.getElementById('total');

        // URLのクエリパラメータを管理
        const body = new URLSearchParams();
        body.append('size_title', size_title.textContent);
        body.append('size_price', size_price.textContent);
        body.append('flavor_title', flavor_title.textContent);
        body.append('flavor_title_2', flavor_title_2.textContent);
        body.append('option_title', option_title.textContent);
        body.append('option_price', option_price.textContent);
        body.append('option_title_2', option_title_2.textContent);
        body.append('option_price_2', option_price_2.textContent);
        body.append('total_price', total_price.textContent);

        fetch(url, {
            method: 'POST',
            body: body,
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8',
                'X-CSRFToken': csrftoken,
            }
        }).then(response => {
            // JSON形式に変換
            return response.json();
        }).then(response => {
             // 選択を初期化
            for ( let i = 0; i < sizeform.length; i++ ) {
                sizeform[i].checked = false;
            }
            for ( let j = 0; j < flavorform.length; j++ ) {
                flavorform[j].checked = false;
            }
            for ( let k = 0; k < optionform.length; k++ ) {
                optionform[k].checked = false;
            }
            // 選択したカート情報を初期化
            size_title.textContent = '';
            size_price.textContent = '';
            flavor_title.textContent = '';
            flavor_title_2.textContent = '';
            option_title.textContent = '';
            option_price.textContent = '';
            option_title_2.textContent = '';
            option_price_2.textContent = '';
            total_price.textContent = response.get_total_price.toLocaleString();
            // 仮の合計金額を初期化
            total.textContent = '';
            // 追加するエレメント
            const postArea = document.getElementById('posts');
            const element  = Object.assign(document.createElement('div'), { className: 'd-flex justify-content-between'});
            const element2  = Object.assign(document.createElement('span'), { textContent: response.size_title });
            const element3  = Object.assign(document.createElement('div'));
            const element4  = Object.assign(document.createElement('span'), { className: 'mr-2', textContent: response.size_price });
            const element5  = Object.assign(document.createElement('span'), { className: 'order_delete', textContent: '✕' });
            const element6  = Object.assign(document.createElement('div'), { className: 'text-left'});
            const element7  = Object.assign(document.createElement('span'), { textContent: response.flavor_title });
            const element8  = Object.assign(document.createElement('div'), { className: 'text-left'});
            const element9  = Object.assign(document.createElement('span'), { textContent: response.flavor_title_2 });
            const element10  = Object.assign(document.createElement('div'), { className: 'd-flex justify-content-between'});
            const element11  = Object.assign(document.createElement('span'), { textContent: response.option_title });
            const element12  = Object.assign(document.createElement('span'), { className: 'mr-4', textContent: response.option_price });
            const element13  = Object.assign(document.createElement('div'), { className: 'd-flex justify-content-between'});
            const element14  = Object.assign(document.createElement('span'), { textContent: response.option_title_2 });
            const element15  = Object.assign(document.createElement('span'), { className: 'mr-4', textContent: response.option_price_2 });
            const element16  = Object.assign(document.createElement('hr'));
            const element17  = Object.assign(document.createElement('div'), { className: 'order_cart'});
            // 階層に合わせて要素をまとめる
            element.appendChild(element2);
            element3.appendChild(element4);
            element3.appendChild(element5);
            element.appendChild(element3);
            element6.appendChild(element7);
            element8.appendChild(element9);
            element10.appendChild(element11);
            element10.appendChild(element12);
            element13.appendChild(element14);
            element13.appendChild(element15);
            element17.appendChild(element);
            element17.appendChild(element6);
            element17.appendChild(element8);
            element17.appendChild(element10);
            element17.appendChild(element13);
            element17.appendChild(element16);
            // 最後に追加
            postArea.insertBefore(element17, postArea.lastChild.nextSibling);
            // 仮の合計値も変更
            const totalArea = document.getElementById('total');
            totalArea.textContent = response.get_total_price;
        }).catch(error => {
            console.log(error);
        });

        // 追加注文された0.1秒後にorder_deleteを取得
        // 削除機能を設定
        window.setTimeout(() => {
            const deleteOrder = document.getElementsByClassName('order_delete');
            for ( let i = 0; i < deleteOrder.length; i++ ) {
                deleteOrder[i].addEventListener('click', () => {
                    console.log(i)
                    const url = '{% url "delete_order" %}';
                    const total_price = document.getElementById('total_price');
                    // URLのクエリパラメータを管理
                    const body = new URLSearchParams();
                    body.append('num', i);

                    fetch(url, {
                        method: 'POST',
                        body: body,
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8',
                            'X-CSRFToken': csrftoken,
                        }
                    }).then(response => {
                        // JSON形式に変換
                        return response.json();
                    }).then(response => {
                        // 合計値を削除後の金額に変更
                        total_price.textContent = response.get_total_price.toLocaleString();
                        // 仮の合計値も削除後の金額に変更
                        const totalArea = document.getElementById('total');
                        totalArea.textContent = response.get_total_price;

                        const cart = document.getElementsByClassName('order_cart');
                        cart[i].style.display = 'none';
                    }).catch(error => {
                        console.log(error);
                    });
                });
            }
        }, 100);
    });

    // リロードに対応
    const del_order = () => {
        const deleteOrder = document.getElementsByClassName('order_delete');
        for ( let i = 0; i < deleteOrder.length; i++ ) {
            deleteOrder[i].addEventListener('click', () => {
                const url = '{% url "delete_order" %}';
                const total_price = document.getElementById('total_price');
                // URLのクエリパラメータを管理
                const body = new URLSearchParams();
                body.append('num', i);

                fetch(url, {
                    method: 'POST',
                    body: body,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8',
                        'X-CSRFToken': csrftoken,
                    }
                }).then(response => {
                    // JSON形式に変換
                    return response.json();
                }).then(response => {
                    // 合計値を削除後の金額に変更
                    total_price.textContent = response.get_total_price.toLocaleString();
                    // 仮の合計値も削除後の金額に変更
                    const totalArea = document.getElementById('total');
                    totalArea.textContent = response.get_total_price;

                    const cart = document.getElementsByClassName('order_cart');
                    cart[i].style.display = 'none';
                }).catch(error => {
                    console.log(error);
                });
            });
        }
    }
</script>
{% endblock %}