{% extends "app/base.html" %}

{% block content %}
<div class="signup-title">
    <span>SIGN UP</span>
</div>

<div class="profile">
    <p>以下の内容でよろしいでしょうか？</p>
    <table class="profile__table">
        <tbody>
            <tr>
                <th>お名前</th>
                <td>{{ name }}</td>
            </tr>
            <tr>
                <th>フリガナ</th>
                <td>{{ furigana }}</td>
            </tr>
            <tr>
                <th>メールアドレス</th>
                <td>{{ email }}</td>
            </tr>
            <tr>
                <th>電話番号</th>
                <td>{{ tel }}</td>
            </tr>
            <tr>
                <th>性別</th>
                {% if gender == None %}
                    <td></td>
                {% else %}
                    <td id="genderArea">{{ gender }}</td>
                {% endif %}
            </tr>
            <tr>
                <th>誕生日</th>
                {% if birthday == None %}
                    <td></td>
                {% else %}
                    <td>{{ birthday }}</td>
                {% endif %}
            </tr>
        </tbody>
    </table>
    <button type="button" onclick=history.back()>戻る</button>
    <!-- <a id="signup_done" class="btn rounded-pill" href="{% url 'account_signup_done' %}">登録</a> -->
    <form id="signup_done" action="{% url 'account_signup_done' %}">
        {% csrf_token %}
        <button type="submit" class="btn rounded-pill" ontouchstart="">登録</button>
    </form>
</div>
{% endblock %}

{% block extrajs %}
<script>
    'use strict';

    //性別を名前表示
    const genderArea = document.getElementById('genderArea');
    if ( '{{ gender }}' == 1 ) {
        genderArea.textContent = '女性';
    } else if ( '{{ gender }}' == 2 ) {
        genderArea.textContent = '男性';
    }

    // CSRF対策
    const getCookie = name => {
        if (document.cookie && document.cookie !== '') {
            for (const cookie of document.cookie.split(';')) {
                const [key, value] = cookie.trim().split('=');
                if (key === name) {
                    return decodeURIComponent(value);
                }
            }
        }
    };
    const csrftoken = getCookie('csrftoken');

    // 登録ボタンクリックで発動
    document.getElementById('signup_done').addEventListener('submit', () => {
        const url = '{% url "account_signup_confirm" %}';

        // 誕生日をYYYY-MM-DD形式に変更
        let birthday = '{{ birthday }}'.replace( /年/g, '-').replace( /月/g, '-').replace( /日/g, '');

        // URLのクエリパラメータを管理
        const body = new URLSearchParams();
        body.append('name', '{{ name }}');
        body.append('furigana', '{{ furigana }}');
        body.append('email', '{{ email }}');
        body.append('tel', '{{ tel }}');
        body.append('gender', '{{ gender }}');
        body.append('birthday', birthday);
        body.append('password', '{{ password }}');

        fetch(url, {
            method: 'POST',
            body: body,
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8',
                'X-CSRFToken': csrftoken,
            }
        })
    });
</script>
{% endblock %}